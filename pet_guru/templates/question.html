{% extends 'base/base.html' %} 
{% load static %} 
{% block content %}
{% block link %}
<link rel="stylesheet" href="{% static 'css/chat.css' %} "/>
{% endblock link %}
<div class="pageContainer">
  <header class="unam-primary sticky-top">
    <div class="container-fluid mainMenu">
      {% block navigation %} {% include 'base/nav.html' %} {% endblock %}
    </div>
  </header>
  <div id="cuestionContainer">
    <div class="py-3 container">
      <h2 class="text-center display-4">{{ titulo }}</h2>
      <h3 class="alert-heading text-center">Descripción de la consulta:</h3>
      <p class="py-3">{{instance.description}}</p>
      <p class="py-2 h4">Calificacón: <i class="fa fa-star" aria-hidden="true"></i></p>
    </div>
    <div id="cuestion" class="py-5 d-flex flex-column justify-content-center align-items-center">
      <div class="alert alert-success w-100 px-3 py-5" role="alert">
        <div class="row">
          <div class="col-sm-12 col-md-4">
            <h2 class="alert-heading text-center mb-4">Datos clínicos.</h2>
            <p>Especie: {{ instance.specie }}</p>
            {% for op in nombres %}
            <p>{{ op.name }}</p>
            {% endfor %}
          </div>
          <hr>
          <div class="col-sm-12 col-md-8">
            <div id="galleryContainer">
              <div id="gallery" style="display:none;">
                {% for image in images %}
                <img alt="Image 1 Title" src="{{image.image.url}}" data-image="{{image.image.url}}" data-description="Image 1 Description"> 
                {% endfor %}
              </div>
            </div>
          </div>
        </div>
      </div>
      <div class="container">
        {% if user.rol == 'ST' and instance.status == 'RP' %}
        <div class="container text-center">
          <h1>Comentarios</h1>
          <div class="row justify-content-end">
            <div class="">
              <input id="message" type="text">
              <button type="submit" class="btn_send btn btn-primary">Enviar</button>
            </div>
          </div>
        </div>      
        <div class="container messages-cont">
          {% for message in messages %}
          {% if request.user.username == message.handle|stringformat:"s" %}
          <div class="row justify-content-end">
            <div class="col-md-7 col-sm-7">
              <div class="card card-message">
                <div class="card-header text-left">
                  {{message.handle}}
                </div>
                <div class="card-body text-left">
                  <p class="card-text">{{message.message}}</p>
                </div>
                <div class="card-footer text-muted text-right">
                  <p>{{ message.formatted_timestamp }}</p>
                </div>
              </div>
            </div>
          </div>
          {% else %}
          <div class="row justify-content-start">
            <div class="col-md-7">
              <div class="card card-message">
                <div class="card-header text-left">
                  {{message.handle}}
                </div>
                <div class="card-body text-left">
                  <p class="card-text">{{message.message}}</p>
                </div>
                <div class="card-footer text-muted text-right">
                  <p>{{ message.formatted_timestamp }}</p>
                </div>
              </div>
            </div>
          </div>
          {% endif %}
          {% endfor %}
        </div>
        {% elif user.rol == 'TC' and instance.status == 'RP' %}
        <div class="container text-center">
          <h1>Comentarios</h1>
          <div class="row justify-content-end">
            <div class="">
              <input id="message" type="text">
              <button type="submit" class="btn_send btn btn-primary">Enviar</button>
            </div>
          </div>
        </div>      
        <div class="container messages-cont">
          {% for message in messages %}
          {% if request.user.username == message.handle|stringformat:"s" %}
          <div class="row justify-content-end">
            <div class="col-md-7 col-sm-7">
              <div class="card card-message">
                <div class="card-header text-left">
                  {{message.handle}}
                </div>
                <div class="card-body text-left">
                  <p class="card-text">{{message.message}}</p>
                </div>
                <div class="card-footer text-muted text-right">
                  <p>{{ message.formatted_timestamp }}</p>
                </div>
              </div>
            </div>
          </div>
          {% else %}
          <div class="row justify-content-start">
            <div class="col-md-7">
              <div class="card card-message">
                <div class="card-header text-left">
                  {{message.handle}}
                </div>
                <div class="card-body text-left">
                  <p class="card-text">{{message.message}}</p>
                </div>
                <div class="card-footer text-muted text-right">
                  <p>{{ message.formatted_timestamp }}</p>
                </div>
              </div>
            </div>
          </div>
          {% endif %}
          {% endfor %}
        </div>
        {% elif user.rol == 'TC' and instance.status == 'OP' %}
        <div class="container text-center">
          <button type="" class="btn btn-primary">Responde la pregunta!</button>
        </div>
        {% else %}
        <div class="container text-center">
          <p class="display-4">En espera de que un profesor responda tu pregunta.</p>
        </div>
        {% endif %}
      </div>      
    </div>
    {% endblock %} 
    {% block javascript%}
    <script type="text/javascript">
    $(function() {
      function send_data() {
        var message = $('#message').val();
        var handler = $('#handle').text();
        $.ajax({
          url: "{% url 'home:pregunta' label %}",
          type: 'POST',
          data: {
            csrfmiddlewaretoken: '{{ csrf_token }}',
            'message': message,
            'handler': '{{request.user.username}}',
          },
          traditional: true,
          datatype: 'jsonp',
          success: function(result) {
            location.reload()
          },
        });
      }
      $(".messages-cont").animate({ scrollTop: $('#div1').prop("scrollHeight")}, 1000);
      $('.btn_send').click(function() {
        send_data();
      });
      $("#message").on('keyup', function(e) {
        if (e.keyCode == 13) {
          send_data();
        }
      });
    });
    </script>
    {% endblock javascript%}